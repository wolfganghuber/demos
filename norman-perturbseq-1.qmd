---
title: "Explore the Norman data"
subtitle: "Step 1: load the single data and compute pseudobulk"
author: "Wolfgang Huber"
date: "2026-01-02"
format:
  html:
    embed-resources: false
    page-layout: full
    css: wh.css
    toc: true
---

# Setup

```{r}
#| label: setup
#| echo: false
#| message: false
#| warning: false
knitr::opts_chunk$set(cache = TRUE)
library("assertthat")
library("sparseMatrixStats")
library("dplyr")
```

# Load data

## Load data V1: from scFoundation

This is what is being used: h5ad file from `/g/huber/users/ahlmanne/projects/perturbation_prediction-benchmark/data/norman_from_scfoundation_data.zip`

```{r}
#| label: loadv1
#| cache: false
#| eval: true
library("anndata")
ad =  read_h5ad("norman-perturbseq-data/scFoundation/GEARS/data/gse133344_k562gi_oe_pert227_84986_19264_withtotalcount.h5ad")
ad
head(ad$obs)
ad$shape
```

## Load data V2: from Kaggle (not used)

h5ad files from <https://www.kaggle.com/datasets/alexandervc/scrnaseq-crisprperturbseqnormanselectedpart?resource=download>. 

```{r}
#| label: loadv2
#| cache: false
#| eval: false
library("anndata")
x =  read_h5ad("GSE133344_Human_K562_CDKN1Arelatedknockouts_Y2019_452Cells_GEO_Counts_Norman_Weissman.h5ad")
x
head(x$obs)
x$shape
```

## Load data V3: from GEO (not used)

The file `GSE146194_RAW.tar` was downloaded from <https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE146194> and untarred. 

```{r}
#| label: loadv3
#| message: false
#| eval: false
path = "norman-perturbseq-data"
assert_that(dir.exists(path))
files = c("GSM4367979_exp1-5.matrix.mtx.gz", "GSM4367984_exp6.matrix.mtx.gz", "GSM4367985_exp7.matrix.mtx.gz", "GSM4367986_exp8.matrix.mtx.gz", "GSM4367987_exp9.matrix.mtx.gz", "GSM4367988_exp10.matrix.mtx.gz", "GSM4367989_exp11.matrix.mtx.gz")
# does not work
# v = lapply(file.path(path, files), readr::read_tsv, show_col_types = FALSE, n_max = 10)
```

# Pseudobulk

`lane` and `gemgroup` are the same. The `lane` variable seems to be **not** confounded with `condition`:

```{r}
#| label: checks
with(ad$obs, table(lane, gemgroup))
tab_cond_lane = with(ad$obs, table(condition, lane))
knitr::kable(tab_cond_lane) |>
  kableExtra::kable_paper() |>
  kableExtra::scroll_box(height = "300px")
```


## Split by condition.

First, we see that among the three variables 
`condition`, `cell_type_condition` and `condition_name` in `ad$obs` there is no relevant difference.

```{r}
#| label: pseudobulk0
assert_that(
  all(as.integer(as.factor(ad$obs$cell_type_condition)) == as.integer(as.factor(ad$obs$condition))),
  all(as.integer(as.factor(ad$obs$condition_name)) == as.integer(as.factor(ad$obs$condition)))
)
```

```{r}
#| label: pseudobulk1
spl = split(seq_along(ad$obs$condition), ad$obs$condition)
numCells = sapply(spl, length)
length(spl)
hist(log10(numCells), 30)
```
Construct count matrix
```{r}
#| label: pseudobulk2
mat = matrix(NA_real_, nrow = dim(ad)[2], ncol = length(spl))
rownames(mat) = ad$var$gene_name
colnames(mat) = names(spl)
for (i in names(spl))
  mat[, i] = sparseMatrixStats::colSums2(ad$X[spl[[i]], , drop = FALSE ])
```

Save
```{r}
#| label: save
save(mat, file = "norman-perturbseq-mat.RData")
```

